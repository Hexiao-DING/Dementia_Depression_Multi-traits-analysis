# ======================================
# Step 0. Prepare linkage disequilibrium reference genotypes
# ======================================
# The .bed/.bim/.fam trio is required by SMR and typically comes from the 1000 Genomes EUR reference panel.
# Adjust the destination path to match the installation directory of SMR on your system.
cp -r ~/plink_project/1KG_EUR_all.bed /mnt/c/Users/user/Desktop/SMR/smr-1.3.1/1KG_EUR/
cp -r ~/plink_project/1KG_EUR_all.bim /mnt/c/Users/user/Desktop/SMR/smr-1.3.1/1KG_EUR/
cp -r ~/plink_project/1KG_EUR_all.fam /mnt/c/Users/user/Desktop/SMR/smr-1.3.1/1KG_EUR/

# Change into the SMR installation directory
cd /mnt/c/Users/user/Desktop/SMR/smr-1.3.1

# ======================================
# Step 1. Inspect available eQTL panels (optional)
# ======================================
# List the eQTL data sets shipped with SMR for brain tissues
head smrBrain.epi

# Example output:
# Brain_Amygdala.lite
# Brain_Anterior_cingulate_cortex_BA24.lite
# Brain_Caudate_basal_ganglia.lite
# ...

# ======================================
# Step 2. Verify that a target gene exists in an eQTL panel (optional)
# ======================================
# Example: confirm that MEGF8 appears in the BA24 cortex panel
awk '$5 ~ /MEGF8/ {print $0}' ./eQTL_besd_lite/Brain_Anterior_cingulate_cortex_BA24.lite.epi | head

# ======================================
# Step 3. Convert eQTL summary data to BESD format (binary format required by SMR)
# ======================================
# Parameter notes:
# --beqtl-summary : Input eQTL summary file in lite format
# --query         : Set to 1 to output metadata for the selected genes
# --genes         : Plain-text file containing the list of target genes (for example Dgene.list.txt)
# --cis-wind      : Cis window size in kilobases (1000 means +/- 1 Mb)
# --peqtl-other   : P-value threshold that retains significant eQTLs
# --out           : Output prefix
# --make-besd     : Produce BESD-formatted output files
./smr-1.3.1-win.exe \
  --beqtl-summary ./eQTL_besd_lite/Brain_Caudate_basal_ganglia.lite \
  --query 1 \
  --genes Dgene.list.txt \
  --cis-wind 1000 \
  --peqtl-other 1.0e-5 \
  --out smrBrain \
  --make-besd

# Generated files include:
#   smrBrain.besd
#   smrBrain.epi
#   smrBrain.log

# ======================================
# Step 4. Run the SMR association test
# ======================================
# Parameter notes:
# --bfile         : Prefix of the PLINK LD reference panel
# --gwas-summary  : GWAS summary statistics file
# --beqtl-summary : BESD-formatted eQTL file produced in the previous step
# --diff-freq     : Frequency-difference threshold (1 inspects every SNP)
# --out           : Output prefix for SMR results
# --thread-num    : Number of threads to use
./smr-1.3.1-win.exe \
  --bfile ./1KG_EUR/1KG_EUR_all \
  --gwas-summary UDsummary.txt \
  --beqtl-summary smrBrain \
  --diff-freq 1 \
  --out mysmr \
  --thread-num 10

# When the run finishes, the key outputs are:
#   mysmr.smr          -> SMR association results
#   mysmr.smr.log      -> Execution log
#   mysmr.smr.manhattan -> Data points for Manhattan-plot visualisation

# ======================================
# Step 5. Export the results (optional)
# ======================================
# Copy the output back to the desktop for convenience
cp -r ./mysmr* /mnt/c/Users/user/Desktop/
